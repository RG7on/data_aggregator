<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Aggregator ‚Äî Control Panel</title>
<style>
  :root { --bg: #0d1117; --surface: #161b22; --surface2: #1c2128; --border: #30363d;
           --text: #c9d1d9; --muted: #8b949e; --accent: #58a6ff; --green: #3fb950;
           --red: #f85149; --yellow: #d29922; --orange: #db6d28; --radius: 8px; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
         background: var(--bg); color: var(--text); line-height: 1.6; padding: 24px; max-width: 1040px; margin: auto; }
  h1 { font-size: 24px; margin-bottom: 4px; }
  .subtitle { color: var(--muted); font-size: 14px; margin-bottom: 24px; }
  h2 { font-size: 18px; margin: 0 0 12px; display: flex; align-items: center; gap: 8px; }
  h2 .badge { font-size: 11px; padding: 2px 8px; border-radius: 12px; background: var(--border); color: var(--muted); font-weight: 400; }
  h3 { font-size: 15px; color: var(--accent); margin: 16px 0 8px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
  .field { margin-bottom: 14px; }
  .field label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 4px; }
  .field input[type="text"], .field input[type="number"], .field input[type="password"], .field select, .field textarea {
    width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 14px; font-family: inherit; }
  .field input:focus, .field select:focus, .field textarea:focus { outline: none; border-color: var(--accent); }
  .field textarea { min-height: 72px; resize: vertical; font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 13px; }
  .field .hint { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .row { display: flex; gap: 12px; }
  .row > .field { flex: 1; }
  .toggle-switch { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
  .toggle-switch input[type="checkbox"] { width: 36px; height: 20px; appearance: none; background: var(--border);
    border-radius: 10px; position: relative; cursor: pointer; transition: .2s; flex-shrink: 0; }
  .toggle-switch input[type="checkbox"]::after { content: ''; position: absolute; width: 16px; height: 16px;
    background: var(--muted); border-radius: 50%; top: 2px; left: 2px; transition: .2s; }
  .toggle-switch input[type="checkbox"]:checked { background: var(--green); }
  .toggle-switch input[type="checkbox"]:checked::after { left: 18px; background: #fff; }
  .toggle-switch label { font-size: 14px; cursor: pointer; }
  .btn-bar { display: flex; gap: 10px; margin-top: 24px; position: sticky; bottom: 0;
             background: var(--bg); padding: 16px 0; border-top: 1px solid var(--border); z-index: 50; }
  .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: .15s; }
  .btn-primary { background: var(--green); color: #fff; }
  .btn-primary:hover { filter: brightness(1.1); }
  .btn-secondary { background: var(--border); color: var(--text); }
  .btn-secondary:hover { background: #3d444d; }
  .btn-sm { padding: 6px 14px; font-size: 13px; }
  .btn-icon { padding: 6px 10px; font-size: 16px; background: transparent; color: var(--muted); border: 1px solid var(--border); border-radius: 6px; }
  .btn-icon:hover { color: var(--red); border-color: var(--red); }
  .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 8px;
           font-size: 14px; font-weight: 500; opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 100; }
  .toast.show { opacity: 1; }
  .toast.success { background: var(--green); color: #fff; }
  .toast.error { background: var(--red); color: #fff; }
  .toast.info { background: var(--accent); color: #fff; }
  .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; gap: 2px; }
  .tab { padding: 10px 18px; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent;
         transition: .2s; font-size: 14px; white-space: nowrap; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
  .help { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
          padding: 16px; margin-bottom: 16px; font-size: 13px; color: var(--muted); }
  .help strong { color: var(--text); }

  /* Report cards */
  .report-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius);
                 padding: 16px; margin-bottom: 12px; }
  .report-card.disabled { opacity: 0.6; }
  .report-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .report-card-header .label-tag { font-size: 14px; font-weight: 600; color: var(--accent);
    background: rgba(88,166,255,0.1); padding: 3px 10px; border-radius: 4px; }
  .report-card .inline-row { display: grid; grid-template-columns: 160px 1fr; gap: 10px; margin-bottom: 8px; align-items: center; }
  .report-card .inline-row label { font-size: 13px; color: var(--muted); }
  .report-card .inline-row input { padding: 6px 10px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 5px; color: var(--text); font-size: 13px; }
  .report-card .inline-row input:focus { outline: none; border-color: var(--accent); }

  /* Status badge */
  .status-bar { display: flex; align-items: center; gap: 8px; padding: 8px 12px; margin-top: 10px;
    background: var(--bg); border-radius: 6px; font-size: 12px; color: var(--muted); }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .status-dot.success { background: var(--green); }
  .status-dot.error { background: var(--red); }
  .status-dot.no_data { background: var(--yellow); }
  .status-dot.pending { background: var(--border); }

  /* Dashboard */
  .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
               padding: 16px; text-align: center; }
  .stat-card .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
  .stat-card .stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .log-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .log-table th { text-align: left; padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--muted); font-weight: 500; }
  .log-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
  .log-table tr:hover { background: var(--surface2); }
  .status-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .status-pill.success { background: rgba(63,185,80,0.15); color: var(--green); }
  .status-pill.error { background: rgba(248,81,73,0.15); color: var(--red); }
  .status-pill.no_data { background: rgba(210,153,34,0.15); color: var(--yellow); }

  .server-status { font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 6px; }
  .server-status .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
  .server-status.offline .dot { background: var(--red); }
  .server-status.offline { color: var(--red); }

  /* Filter wizard panel */
  .filter-panel { margin-top: 12px; padding: 12px 14px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; }
  .filter-panel h4 { font-size: 13px; color: var(--accent); margin: 0 0 10px; display: flex; align-items: center; gap: 6px; }
  .filter-step { margin-bottom: 10px; padding: 8px 10px; background: var(--surface); border-radius: 5px; }
  .filter-step .step-label { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; margin-bottom: 6px; }
  .filter-field { display: grid; grid-template-columns: 140px 1fr; gap: 8px; align-items: center; margin-bottom: 6px; }
  .filter-field label { font-size: 12px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .filter-field input, .filter-field select { padding: 5px 8px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 4px; color: var(--text); font-size: 12px; font-family: inherit; }
  .filter-field input:focus, .filter-field select:focus { outline: none; border-color: var(--accent); }
  .filter-field select[multiple] { min-height: 60px; }
  .filter-field .hint { font-size: 10px; color: var(--muted); grid-column: 2; margin-top: -4px; }
  .filter-field .vl-badge { display: inline-block; padding: 1px 6px; font-size: 10px; border-radius: 3px;
    background: rgba(88,166,255,0.12); color: var(--accent); margin-left: 4px; }
  .filter-sub { margin-left: 0; padding: 6px 0 2px; }
  .filter-sub .sub-row { display: flex; gap: 8px; align-items: center; margin-bottom: 5px; flex-wrap: wrap; }
  .filter-sub .sub-row label { font-size: 11px; color: var(--muted); min-width: 56px; }
  .filter-sub .sub-row input[type="date"], .filter-sub .sub-row input[type="time"] {
    padding: 4px 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    color: var(--text); font-size: 12px; font-family: inherit; }
  .filter-sub .sub-row input:focus { outline: none; border-color: var(--accent); }
  .filter-sub .sub-row select { padding: 4px 6px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 4px; color: var(--text); font-size: 12px; }
  .filter-sub .sub-row span.to { font-size: 11px; color: var(--muted); }
  .vl-section { margin-top: 6px; }
  .vl-section .vl-toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; flex-wrap: wrap; }
  .vl-section .vl-toolbar input[type="text"] { flex: 1; min-width: 140px; padding: 4px 8px; background: var(--bg);
    border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 12px; }
  .vl-section .vl-toolbar button { padding: 3px 10px; font-size: 11px; border: 1px solid var(--border);
    background: var(--surface); color: var(--muted); border-radius: 4px; cursor: pointer; white-space: nowrap; }
  .vl-section .vl-toolbar button:hover { color: var(--accent); border-color: var(--accent); }
  .vl-section .vl-count { font-size: 11px; color: var(--muted); margin-left: auto; white-space: nowrap; }
  .vl-section .vl-checklist { max-height: 220px; overflow-y: auto; border: 1px solid var(--border);
    border-radius: 4px; background: var(--bg); padding: 2px 0; }
  .vl-section .vl-checklist label { display: flex; align-items: center; gap: 6px; padding: 3px 10px;
    font-size: 12px; cursor: pointer; user-select: none; }
  .vl-section .vl-checklist label:hover { background: var(--surface2); }
  .vl-section .vl-checklist input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--accent);
    cursor: pointer; flex-shrink: 0; }
  .vl-section .vl-checklist .vl-group-header { padding: 4px 10px; font-size: 11px; font-weight: 600;
    color: var(--accent); background: var(--surface); border-bottom: 1px solid var(--border); position: sticky; top: 0; }
  .vl-groups { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
  .vl-groups .vl-group-btn { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px;
    font-size: 11px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface);
    color: var(--text); cursor: pointer; user-select: none; transition: .15s; }
  .vl-groups .vl-group-btn:hover { border-color: var(--accent); color: var(--accent); }
  .vl-groups .vl-group-btn .vl-g-count { color: var(--muted); font-size: 10px; }
  .vl-groups .vl-group-btn.active { background: rgba(88,166,255,0.15); border-color: var(--accent); color: var(--accent); }
  .btn-discover { padding: 5px 12px; font-size: 12px; font-weight: 600; border: 1px solid var(--accent);
    background: rgba(88,166,255,0.1); color: var(--accent); border-radius: 5px; cursor: pointer;
    display: inline-flex; align-items: center; gap: 4px; transition: .15s; }
  .btn-discover:hover { background: rgba(88,166,255,0.2); }
  .btn-discover:disabled { opacity: 0.5; cursor: wait; }
  .btn-discover .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .filter-clear { font-size: 11px; color: var(--muted); cursor: pointer; margin-left: auto; }
  .filter-clear:hover { color: var(--red); }
</style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:flex-start;">
  <div>
    <h1>‚öôÔ∏è Data Aggregator Control Panel</h1>
    <p class="subtitle">Configure workers, manage reports, and monitor scrape status.</p>
  </div>
  <div class="server-status" id="server-status">
    <span class="dot"></span>
    <span id="server-status-text">Connected</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="dashboard">Dashboard</div>
  <div class="tab" data-tab="global">Global</div>
  <div class="tab" data-tab="cuic">CUIC Worker</div>
  <div class="tab" data-tab="smax">SMAX Worker</div>
  <div class="tab" data-tab="export">Export / Import</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  DASHBOARD TAB                                                         -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content active" id="tab-dashboard">
  <div class="dashboard-grid">
    <div class="stat-card">
      <div class="stat-value" id="stat-total-reports">-</div>
      <div class="stat-label">Configured Reports</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-last-run">-</div>
      <div class="stat-label">Last Scrape</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-success-rate">-</div>
      <div class="stat-label">Success Rate</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="stat-total-rows">-</div>
      <div class="stat-label">Total Rows (Last Run)</div>
    </div>
  </div>

  <div class="card">
    <h2>Recent Scrape History</h2>
    <div style="max-height:400px; overflow-y:auto;">
      <table class="log-table">
        <thead><tr><th>Time</th><th>Source</th><th>Report</th><th>Status</th><th>Rows</th><th>Duration</th><th>Message</th></tr></thead>
        <tbody id="scrape-log-body"><tr><td colspan="7" style="text-align:center;color:var(--muted)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  GLOBAL TAB                                                            -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-global">
  <div class="card">
    <h2>Browser</h2>
    <div class="toggle-switch">
      <input type="checkbox" id="g-headless" checked>
      <label for="g-headless">Headless mode <span style="color:var(--muted)">(no visible browser window)</span></label>
    </div>
    <div class="toggle-switch">
      <input type="checkbox" id="g-system-chrome" checked>
      <label for="g-system-chrome">Use system Chrome</label>
    </div>
  </div>

  <div class="card">
    <h2>Screenshots</h2>
    <div class="toggle-switch">
      <input type="checkbox" id="g-screenshot-steps">
      <label for="g-screenshot-steps">Screenshot every step <span style="color:var(--muted)">(slow but useful for debugging)</span></label>
    </div>
    <div class="toggle-switch">
      <input type="checkbox" id="g-screenshot-errors" checked>
      <label for="g-screenshot-errors">Screenshot on errors</label>
    </div>
  </div>

  <div class="card">
    <h2>Logging & Storage</h2>
    <div class="row">
      <div class="field">
        <label>Log Level</label>
        <select id="g-log-level">
          <option value="DEBUG">DEBUG</option>
          <option value="INFO" selected>INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
        </select>
      </div>
      <div class="field">
        <label>Data Retention (days)</label>
        <input type="number" id="g-retention" value="90" min="1">
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label>Output Directory</label>
        <input type="text" id="g-output-dir" value="output">
        <div class="hint">Relative to project root</div>
      </div>
      <div class="field">
        <label>Log Directory</label>
        <input type="text" id="g-log-dir" value="logs">
      </div>
    </div>
    <div class="field">
      <label>Shared Drive CSV Path</label>
      <input type="text" id="g-shared-drive" value="" placeholder="\\\\server\\share\\kpi_snapshots.csv">
      <div class="hint">UNC path to auto-export CSV for Power BI. Leave empty to disable.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  CUIC TAB                                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-cuic">
  <div class="card">
    <h2>CUIC Worker <span class="badge">cuic_worker.py</span></h2>
    <div class="toggle-switch">
      <input type="checkbox" id="cuic-enabled" checked>
      <label for="cuic-enabled">Enabled</label>
    </div>

    <h3>Connection</h3>
    <div class="field">
      <label>CUIC URL</label>
      <input type="text" id="cuic-url" value="https://148.151.32.77:8444/cuicui/Main.jsp">
    </div>
    <div class="row">
      <div class="field">
        <label>Username</label>
        <input type="text" id="cuic-user" value="">
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="cuic-pass" value="">
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0">Reports</h2>
      <button class="btn btn-secondary btn-sm" onclick="addCuicReport()">+ Add Report</button>
    </div>
    <div class="help">
      Each report specifies a <strong>folder path</strong> and <strong>report name</strong> as they appear in the CUIC reports list.
      Use <code>/</code> to separate nested folders (e.g. <code>Stock/CCE/CCE_AF_Historical</code>).
      The <strong>label</strong> is a short unique identifier used for tracking (e.g. <code>agent_hist</code>).
    </div>
    <div id="cuic-reports-list"></div>
  </div>

  <div class="card">
    <h3>Timeouts (ms)</h3>
    <div class="help">Lower values = faster, but may cause failures on slow networks. Raise if the worker times out.</div>
    <div class="row">
      <div class="field"><label>Navigation</label><input type="number" id="cuic-t-nav" value="30000"></div>
      <div class="field"><label>Short wait</label><input type="number" id="cuic-t-short" value="1500"></div>
    </div>
    <div class="row">
      <div class="field"><label>Medium wait</label><input type="number" id="cuic-t-medium" value="2500"></div>
      <div class="field"><label>Long wait</label><input type="number" id="cuic-t-long" value="8000"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SMAX TAB                                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-smax">
  <div class="card">
    <h2>SMAX Worker <span class="badge">smax_worker.py</span></h2>
    <div class="toggle-switch">
      <input type="checkbox" id="smax-enabled">
      <label for="smax-enabled">Enabled</label>
    </div>

    <h3>Connection</h3>
    <div class="field">
      <label>Base URL</label>
      <input type="text" id="smax-url" value="https://smax.corp.pdo.om">
    </div>
    <div class="row">
      <div class="field"><label>Username</label><input type="text" id="smax-user" value=""></div>
      <div class="field"><label>Password</label><input type="password" id="smax-pass" value=""></div>
    </div>

    <h3>Report URLs</h3>
    <div class="field">
      <label>One URL per line</label>
      <textarea id="smax-urls" rows="6"></textarea>
    </div>

    <h3>Timeouts (ms)</h3>
    <div class="row">
      <div class="field"><label>Page Load</label><input type="number" id="smax-t-load" value="120000"></div>
      <div class="field"><label>Element Wait</label><input type="number" id="smax-t-elem" value="30000"></div>
    </div>
    <div class="row">
      <div class="field"><label>Tab Stagger Delay</label><input type="number" id="smax-t-stagger" value="2000"></div>
      <div class="field"><label>Max Retries</label><input type="number" id="smax-retries" value="2" min="0"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  EXPORT / IMPORT TAB                                                   -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-export">
  <div class="help">
    <strong>How to use:</strong> Click "Generate JSON" to see the current configuration.
    You can also paste JSON below and click "Load into form" to update the form.
  </div>
  <div class="card">
    <h2>settings.json</h2>
    <div class="field"><textarea id="out-settings" rows="16" readonly></textarea></div>
    <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('out-settings')">üìã Copy</button>
  </div>
  <div class="card">
    <h2>credentials.json</h2>
    <div class="field"><textarea id="out-credentials" rows="8" readonly></textarea></div>
    <button class="btn btn-secondary btn-sm" onclick="copyToClipboard('out-credentials')">üìã Copy</button>
  </div>
  <div style="margin-top:16px">
    <h3>Load from JSON</h3>
    <div class="row">
      <div class="field">
        <label>Paste settings.json</label>
        <textarea id="in-settings" rows="6" placeholder='Paste settings.json content here...'></textarea>
      </div>
      <div class="field">
        <label>Paste credentials.json</label>
        <textarea id="in-credentials" rows="6" placeholder='Paste credentials.json content here...'></textarea>
      </div>
    </div>
    <button class="btn btn-secondary btn-sm" onclick="loadFromJSON()">‚¨ÜÔ∏è Load into form</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SAVE BAR                                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="btn-bar">
  <button class="btn btn-primary" onclick="saveAll()">üíæ Save Settings</button>
  <button class="btn btn-secondary" onclick="generateJSON()">üìÑ Generate JSON</button>
  <button class="btn btn-secondary" onclick="resetDefaults()">‚Ü©Ô∏è Reset Defaults</button>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cuicReports = [];
let scrapeStatus = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUIC REPORT CARDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCuicReports() {
  const container = document.getElementById('cuic-reports-list');
  if (cuicReports.length === 0) {
    container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">No reports configured. Click "+ Add Report" to get started.</p>';
    return;
  }
  container.innerHTML = cuicReports.map((r, i) => {
    const st = scrapeStatus['cuic:' + r.label];
    let statusHtml = '<div class="status-bar"><span class="status-dot pending"></span> Never scraped</div>';
    if (st) {
      const icon = st.status === 'success' ? '\u2705' : st.status === 'error' ? '\u274C' : '\u26A0\uFE0F';
      const dur = st.duration_s ? st.duration_s.toFixed(1) + 's' : '';
      const msg = st.message ? ' \u2014 ' + esc(st.message) : '';
      statusHtml = `<div class="status-bar"><span class="status-dot ${st.status}"></span>
        <span>${icon} ${esc(st.timestamp)} \u00B7 ${st.row_count || 0} rows \u00B7 ${dur}${msg}</span></div>`;
    }
    const filterHtml = renderFilterPanel(r, i);
    return `<div class="report-card ${r.enabled ? '' : 'disabled'}">
      <div class="report-card-header">
        <span class="label-tag">${esc(r.label || 'unnamed')}</span>
        <div style="display:flex;gap:6px;align-items:center">
          <div class="toggle-switch" style="margin:0">
            <input type="checkbox" id="rpt-en-${i}" ${r.enabled ? 'checked' : ''}
              onchange="cuicReports[${i}].enabled=this.checked;renderCuicReports()">
            <label for="rpt-en-${i}" style="font-size:12px">Enabled</label>
          </div>
          <button class="btn btn-icon btn-sm" onclick="removeCuicReport(${i})" title="Remove">\uD83D\uDDD1\uFE0F</button>
        </div>
      </div>
      <div class="inline-row"><label>Label</label><input value="${attr(r.label)}" onchange="cuicReports[${i}].label=this.value" placeholder="e.g. call_type_hist"></div>
      <div class="inline-row"><label>Folder</label><input value="${attr(r.folder)}" onchange="cuicReports[${i}].folder=this.value" placeholder="e.g. Stock/CCE/CCE_AF_Historical"></div>
      <div class="inline-row"><label>Report Name</label><input value="${attr(r.name)}" onchange="cuicReports[${i}].name=this.value" placeholder="Exact name in CUIC"></div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:8px;">
        <button class="btn-discover" id="discover-btn-${i}" onclick="discoverFilters(${i})">
          \u25B6 Discover Filters
        </button>
        <span style="font-size:11px;color:var(--muted)">Opens browser to read the report\u2019s filter wizard</span>
      </div>
      ${filterHtml}
      ${statusHtml}
    </div>`;
  }).join('');
}

function addCuicReport() {
  cuicReports.push({ label: '', folder: '', name: '', enabled: true, filters: {} });
  renderCuicReports();
  document.getElementById('cuic-reports-list').lastElementChild?.scrollIntoView({ behavior: 'smooth' });
}

function removeCuicReport(i) {
  if (cuicReports.length <= 1) { showToast('Keep at least one report', 'error'); return; }
  cuicReports.splice(i, 1);
  renderCuicReports();
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function attr(s) { return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTER WIZARD DISCOVERY & RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderFilterPanel(report, idx) {
  const filters = report.filters || {};
  const meta = report._wizard_meta || filters._meta || null;

  if (!meta) {
    // No metadata at all
    if (Object.keys(filters).length > 0) {
      return `<div class="filter-panel">
        <h4>\uD83C\uDFA8 Saved Filters (raw)</h4>
        <pre style="font-size:11px;color:var(--muted);overflow-x:auto;">${esc(JSON.stringify(filters,null,2))}</pre>
        <button class="btn-discover" style="margin-top:6px" onclick="discoverFilters(${idx})">\u25B6 Re-discover</button>
      </div>`;
    }
    return '';
  }

  const isCuic = meta.type === 'cuic_spab';

  let html = `<div class="filter-panel">
    <h4>${isCuic ? '\uD83C\uDFAF' : '\uD83C\uDFA8'} Filter Wizard Settings
      <span class="filter-clear" onclick="clearFilters(${idx})">\u2716 Clear all</span>
    </h4>`;

  if (isCuic) {
    // ‚îÄ‚îÄ CUIC AngularJS params (flat param-name keys) ‚îÄ‚îÄ
    const params = meta.params || [];
    params.forEach(p => {
      const pn = p.paramName || '';
      const label = p.label || pn;
      const savedVal = filters[pn];

      if (p.type === 'cuic_datetime') {
        // Saved value can be a string preset or an object {preset, date1, date2, allTime, time1, time2}
        const cfg = typeof savedVal === 'string' ? {preset: savedVal}
                  : (savedVal && typeof savedVal === 'object' ? savedVal : {});
        const curPreset = cfg.preset || '';

        // Date Range preset dropdown
        const presets = p.datePresets || [];
        let opts = presets.map(o => {
          const sel = curPreset === o.value ? 'selected' : '';
          return `<option value="${attr(o.value)}" ${sel}>${esc(o.label)}</option>`;
        }).join('');
        const noSel = !curPreset ? 'selected' : '';
        opts = `<option value="" ${noSel}>\u2014 use default \u2014</option>` + opts;

        const dtId = 'dt-' + idx + '-' + pn.replace(/[^a-zA-Z0-9]/g,'_');
        html += `<div class="filter-field">
          <label title="${attr(pn)}">${esc(label)}</label>
          <select id="${dtId}-preset" onchange="updateCuicDatetime(${idx},'${attr(pn)}','preset',this.value)">${opts}</select>
        </div>`;

        // Custom date range (shown when preset = CUSTOM)
        if (p.hasDateRange) {
          const showDates = curPreset === 'CUSTOM' ? '' : 'style="display:none"';
          const d1 = cfg.date1 || '';
          const d2 = cfg.date2 || '';
          html += `<div class="filter-sub" id="${dtId}-dates" ${showDates}>
            <div class="sub-row">
              <label>From</label>
              <input type="date" value="${attr(d1)}" onchange="updateCuicDatetime(${idx},'${attr(pn)}','date1',this.value)">
              <span class="to">to</span>
              <input type="date" value="${attr(d2)}" onchange="updateCuicDatetime(${idx},'${attr(pn)}','date2',this.value)">
            </div>
          </div>`;
        }

        // Time range (All Day / Custom)
        if (p.hasTimeRange) {
          const allTime = cfg.allTime || 1;
          const t1 = cfg.time1 || '';
          const t2 = cfg.time2 || '';
          const showTimes = allTime === 2 ? '' : 'style="display:none"';
          html += `<div class="filter-sub">
            <div class="sub-row">
              <label>Time</label>
              <select onchange="updateCuicDatetime(${idx},'${attr(pn)}','allTime',parseInt(this.value));
                document.getElementById('${dtId}-times').style.display=this.value==='2'?'':'none'">
                <option value="1" ${allTime===1?'selected':''}>All Day</option>
                <option value="2" ${allTime===2?'selected':''}>Custom</option>
              </select>
            </div>
            <div class="sub-row" id="${dtId}-times" ${showTimes}>
              <label>From</label>
              <input type="time" step="1" value="${attr(t1)}" onchange="updateCuicDatetime(${idx},'${attr(pn)}','time1',this.value)">
              <span class="to">to</span>
              <input type="time" step="1" value="${attr(t2)}" onchange="updateCuicDatetime(${idx},'${attr(pn)}','time2',this.value)">
            </div>
          </div>`;
        }

      } else if (p.type === 'cuic_valuelist') {
        // Value list with checkbox grid
        const isAll = savedVal === 'all';
        const isSpecific = Array.isArray(savedVal);
        const selectedNames = isSpecific ? savedVal : [];
        const allNames = p.availableNames || [];
        const badge = `<span class="vl-badge">${allNames.length} available</span>`;
        const vlId = 'vl-' + idx + '-' + pn.replace(/[^a-zA-Z0-9]/g,'_');
        const selCount = isAll ? allNames.length : selectedNames.length;

        html += `<div class="filter-field">
          <label title="${attr(pn)}">${esc(label)} ${badge}</label>
          <span style="font-size:12px;color:${selCount>0?'var(--green)':'var(--muted)'}">${selCount} selected</span>
        </div>`;

        // Groups + Toolbar: search + select all / deselect all
        const groups = p.availableGroups || [];
        html += `<div class="vl-section" id="${vlId}-section">`;

        // Group toggle buttons
        if (groups.length) {
          html += `<div class="vl-groups" id="${vlId}-groups">`;
          groups.forEach((g, gi) => {
            const members = g.members || [];
            const allChecked = members.length > 0 && members.every(m => isAll || selectedNames.includes(m));
            html += `<button class="vl-group-btn${allChecked?' active':''}" data-gidx="${gi}"
              onclick="vlToggleGroup(${idx},'${attr(pn)}','${vlId}',${gi})">
              ${esc(g.name)} <span class="vl-g-count">(${g.count})</span>
            </button>`;
          });
          html += `</div>`;
        }

        html += `<div class="vl-toolbar">
            <input type="text" id="${vlId}-search" placeholder="\uD83D\uDD0D Filter names..."
              oninput="filterVlChecklist('${vlId}',this.value)">
            <button onclick="vlCheckAll(${idx},'${attr(pn)}','${vlId}')">\u2611 All</button>
            <button onclick="vlUncheckAll(${idx},'${attr(pn)}','${vlId}')">\u2610 None</button>
            <span class="vl-count" id="${vlId}-count">${selCount} / ${allNames.length}</span>
          </div>
          <div class="vl-checklist" id="${vlId}-list">`;

        // Build a set of group members for highlighting
        const groupMemberSet = new Set();
        groups.forEach(g => (g.members || []).forEach(m => groupMemberSet.add(m)));

        // All items as checkboxes
        allNames.forEach(n => {
          const checked = isAll || selectedNames.includes(n) ? 'checked' : '';
          // Tag each checkbox with its group memberships for toggle logic
          const memberOf = groups.filter(g => (g.members||[]).includes(n)).map(g => g.name).join(',');
          html += `<label data-name="${attr(n.toLowerCase())}" data-groups="${attr(memberOf)}">
            <input type="checkbox" value="${attr(n)}" ${checked}
              onchange="vlToggleItem(${idx},'${attr(pn)}','${vlId}')">
            <span>${esc(n)}</span>
          </label>`;
        });

        html += `</div>
        </div>`;

      } else if (p.type === 'checkbox') {
        const checked = savedVal !== undefined ? savedVal : (p.currentValue || false);
        html += `<div class="filter-field">
          <label title="${attr(pn)}">${esc(label)}</label>
          <input type="checkbox" ${checked?'checked':''}
            onchange="updateCuicFilter(${idx},'${attr(pn)}',this.checked)"
            style="width:auto;">
        </div>`;

      } else {
        // text / number
        const val = savedVal !== undefined ? savedVal : (p.currentValue || '');
        const inputType = p.type === 'number' ? 'number' : 'text';
        html += `<div class="filter-field">
          <label title="${attr(pn)}">${esc(label)}</label>
          <input type="${inputType}" value="${attr(String(val))}"
            onchange="updateCuicFilter(${idx},'${attr(pn)}',this.value)">
        </div>`;
      }
    });
    html += '</div>';
    return html;
  }

  // ‚îÄ‚îÄ Generic step-based wizard ‚îÄ‚îÄ
  (meta.steps || []).forEach(step => {
    const stepKey = 'step_' + step.step;
    const savedStep = filters[stepKey] || {};
    html += `<div class="filter-step">
      <div class="step-label">Step ${step.step}</div>`;

    (step.fields || []).forEach(field => {
      const key = field.id || field.name || field.label || '';
      if (!key) return;
      const savedVal = savedStep[key];
      const displayLabel = field.label || field.name || field.id;

      if (field.type === 'select') {
        const isMulti = field.multiple ? 'multiple' : '';
        let opts = (field.options || []).map(o => {
          const sel = savedVal !== undefined
            ? (Array.isArray(savedVal) ? savedVal.includes(o.value) : savedVal === o.value)
            : o.selected;
          return `<option value="${attr(o.value)}" ${sel?'selected':''}>${esc(o.text)}</option>`;
        }).join('');
        html += `<div class="filter-field">
          <label title="${attr(key)}">${esc(displayLabel)}</label>
          <select ${isMulti} onchange="updateFilterValue(${idx},'${stepKey}','${attr(key)}',this)">${opts}</select>
        </div>`;
      } else if (field.type === 'checkbox') {
        const checked = savedVal !== undefined ? savedVal : field.value;
        html += `<div class="filter-field">
          <label title="${attr(key)}">${esc(displayLabel)}</label>
          <input type="checkbox" ${checked?'checked':''}
            onchange="updateFilterValue(${idx},'${stepKey}','${attr(key)}',this)"
            style="width:auto;">
        </div>`;
      } else {
        const val = savedVal !== undefined ? savedVal : (field.value || '');
        const inputType = field.inputType || 'text';
        html += `<div class="filter-field">
          <label title="${attr(key)}">${esc(displayLabel)}</label>
          <input type="${inputType}" value="${attr(String(val))}"
            onchange="updateFilterValue(${idx},'${stepKey}','${attr(key)}',this)">
        </div>`;
      }
    });
    html += '</div>';
  });
  html += '</div>';
  return html;
}

/* ‚îÄ‚îÄ CUIC flat filter update ‚îÄ‚îÄ */
function updateCuicFilter(reportIdx, paramName, value) {
  const report = cuicReports[reportIdx];
  if (!report.filters) report.filters = {};
  if (value === '' || value === undefined) {
    delete report.filters[paramName];
  } else {
    report.filters[paramName] = value;
  }
}

/* ‚îÄ‚îÄ CUIC datetime update (builds object: {preset, date1, date2, allTime, time1, time2}) ‚îÄ‚îÄ */
function updateCuicDatetime(reportIdx, paramName, field, value) {
  const report = cuicReports[reportIdx];
  if (!report.filters) report.filters = {};

  let cur = report.filters[paramName];
  // Normalize to object
  if (typeof cur === 'string') cur = {preset: cur};
  if (!cur || typeof cur !== 'object') cur = {};

  cur[field] = value;

  // When preset changes, toggle custom date fields visibility
  if (field === 'preset') {
    const dtId = 'dt-' + reportIdx + '-' + paramName.replace(/[^a-zA-Z0-9]/g,'_');
    const datesEl = document.getElementById(dtId + '-dates');
    if (datesEl) datesEl.style.display = value === 'CUSTOM' ? '' : 'none';
  }

  // If only preset and it's not CUSTOM, store as simple string
  const keys = Object.keys(cur).filter(k => cur[k] !== undefined && cur[k] !== '');
  if (keys.length === 1 && keys[0] === 'preset' && cur.preset !== 'CUSTOM') {
    report.filters[paramName] = cur.preset || undefined;
    if (!cur.preset) delete report.filters[paramName];
  } else {
    report.filters[paramName] = cur;
  }
}

/* ‚îÄ‚îÄ CUIC valuelist: toggle a single checkbox ‚îÄ‚îÄ */
function vlToggleItem(reportIdx, paramName, vlId) {
  const report = cuicReports[reportIdx];
  if (!report.filters) report.filters = {};
  const listEl = document.getElementById(vlId + '-list');
  if (!listEl) return;
  const checked = Array.from(listEl.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
  const total = listEl.querySelectorAll('input[type=checkbox]').length;
  report.filters[paramName] = checked.length === total ? 'all' : checked;
  // Update count
  const countEl = document.getElementById(vlId + '-count');
  if (countEl) countEl.textContent = checked.length + ' / ' + total;
  // Update group button highlights
  vlUpdateGroupButtons(vlId, reportIdx, paramName);
}

/* ‚îÄ‚îÄ CUIC valuelist: check all (visible) ‚îÄ‚îÄ */
function vlCheckAll(reportIdx, paramName, vlId) {
  const listEl = document.getElementById(vlId + '-list');
  if (!listEl) return;
  listEl.querySelectorAll('label').forEach(lbl => {
    if (lbl.style.display !== 'none') {
      const cb = lbl.querySelector('input[type=checkbox]');
      if (cb) cb.checked = true;
    }
  });
  vlToggleItem(reportIdx, paramName, vlId);
}

/* ‚îÄ‚îÄ CUIC valuelist: uncheck all (visible) ‚îÄ‚îÄ */
function vlUncheckAll(reportIdx, paramName, vlId) {
  const listEl = document.getElementById(vlId + '-list');
  if (!listEl) return;
  listEl.querySelectorAll('label').forEach(lbl => {
    if (lbl.style.display !== 'none') {
      const cb = lbl.querySelector('input[type=checkbox]');
      if (cb) cb.checked = false;
    }
  });
  vlToggleItem(reportIdx, paramName, vlId);
}

/* ‚îÄ‚îÄ CUIC valuelist: filter checklist by search text ‚îÄ‚îÄ */
function filterVlChecklist(vlId, query) {
  const listEl = document.getElementById(vlId + '-list');
  if (!listEl) return;
  const q = (query || '').toLowerCase();
  listEl.querySelectorAll('label').forEach(lbl => {
    const name = lbl.getAttribute('data-name') || '';
    lbl.style.display = (!q || name.includes(q)) ? '' : 'none';
  });
}

/* ‚îÄ‚îÄ CUIC valuelist: toggle a group (select/deselect all its members) ‚îÄ‚îÄ */
function vlToggleGroup(reportIdx, paramName, vlId, groupIdx) {
  const report = cuicReports[reportIdx];
  const meta = report._wizard_meta || (report.filters && report.filters._meta) || {};
  const params = meta.params || [];
  const p = params.find(pp => pp.paramName === paramName);
  if (!p) return;
  const group = (p.availableGroups || [])[groupIdx];
  if (!group || !group.members) return;

  const listEl = document.getElementById(vlId + '-list');
  if (!listEl) return;

  // Determine current state: if all members are checked, uncheck them; otherwise check all
  const memberSet = new Set(group.members);
  const memberCbs = Array.from(listEl.querySelectorAll('input[type=checkbox]'))
    .filter(cb => memberSet.has(cb.value));
  const allChecked = memberCbs.every(cb => cb.checked);

  memberCbs.forEach(cb => cb.checked = !allChecked);

  // Update data model
  vlToggleItem(reportIdx, paramName, vlId);

  // Update group button active state
  vlUpdateGroupButtons(vlId, reportIdx, paramName);
}

/* ‚îÄ‚îÄ Update group button active/inactive styling ‚îÄ‚îÄ */
function vlUpdateGroupButtons(vlId, reportIdx, paramName) {
  const groupsEl = document.getElementById(vlId + '-groups');
  if (!groupsEl) return;
  const report = cuicReports[reportIdx];
  const meta = report._wizard_meta || (report.filters && report.filters._meta) || {};
  const params = meta.params || [];
  const p = params.find(pp => pp.paramName === paramName);
  if (!p) return;

  const listEl = document.getElementById(vlId + '-list');
  if (!listEl) return;
  const checkedVals = new Set(Array.from(listEl.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value));

  groupsEl.querySelectorAll('.vl-group-btn').forEach(btn => {
    const gi = parseInt(btn.getAttribute('data-gidx'));
    const g = (p.availableGroups || [])[gi];
    if (!g || !g.members) return;
    const allIn = g.members.every(m => checkedVals.has(m));
    btn.classList.toggle('active', allIn);
  });
}

/* ‚îÄ‚îÄ Generic step-based filter update ‚îÄ‚îÄ */
function updateFilterValue(reportIdx, stepKey, fieldKey, el) {
  const report = cuicReports[reportIdx];
  if (!report.filters) report.filters = {};
  if (!report.filters[stepKey]) report.filters[stepKey] = {};

  if (el.type === 'checkbox') {
    report.filters[stepKey][fieldKey] = el.checked;
  } else if (el.tagName === 'SELECT' && el.multiple) {
    report.filters[stepKey][fieldKey] = Array.from(el.selectedOptions).map(o => o.value);
  } else {
    report.filters[stepKey][fieldKey] = el.value;
  }
}

function clearFilters(reportIdx) {
  const report = cuicReports[reportIdx];
  const meta = report._wizard_meta || (report.filters && report.filters._meta) || null;
  report.filters = {};
  if (meta) report.filters._meta = meta;
  renderCuicReports();
  showToast('Filters cleared for ' + (report.label || 'report'), 'info');
}

async function discoverFilters(reportIdx) {
  const report = cuicReports[reportIdx];
  const btn = document.getElementById('discover-btn-' + reportIdx);

  if (!report.folder || !report.name) {
    showToast('Set folder and report name first', 'error');
    return;
  }

  const origHtml = btn.innerHTML;
  btn.innerHTML = '<span class="spinner"></span> Discovering...';
  btn.disabled = true;
  showToast('Launching browser to discover wizard fields... This may take 30-60s.', 'info');

  try {
    const res = await fetch('/api/discover-filters', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ folder: report.folder, name: report.name })
    });
    const data = await res.json();

    if (data.error) {
      showToast('Discovery error: ' + data.error, 'error');
      return;
    }

    if (!data.steps || data.steps.length === 0) {
      showToast('No wizard steps found', 'error');
      return;
    }

    const isCuic = data.type === 'cuic_spab';

    if (isCuic) {
      // ‚îÄ‚îÄ CUIC format: flat param-name keys ‚îÄ‚îÄ
      const params = data.params || [];
      const metaObj = {
        type: 'cuic_spab',
        params: params,
        datePresets: data.datePresets || []
      };
      report._wizard_meta = metaObj;
      if (!report.filters) report.filters = {};
      report.filters._meta = metaObj;

      // Pre-populate with safe defaults (don't overwrite existing)
      params.forEach(p => {
        const pn = p.paramName;
        if (!pn || report.filters[pn] !== undefined) return;
        // Set sensible defaults
        if (p.type === 'cuic_datetime' && p.currentPreset) {
          report.filters[pn] = p.currentPreset;
        }
        // Leave valuelist empty ‚Äî user must choose
      });
      showToast(`Discovered ${params.length} CUIC parameter(s)!`, 'success');

    } else {
      // ‚îÄ‚îÄ Generic step-based format ‚îÄ‚îÄ
      report._wizard_meta = { steps: data.steps };
      if (!report.filters) report.filters = {};
      report.filters._meta = { steps: data.steps };

      data.steps.forEach(step => {
        const stepKey = 'step_' + step.step;
        if (!report.filters[stepKey]) report.filters[stepKey] = {};
        (step.fields || []).forEach(field => {
          const key = field.id || field.name || field.label;
          if (!key) return;
          if (report.filters[stepKey][key] === undefined) {
            report.filters[stepKey][key] = field.value;
          }
        });
      });
      showToast(`Discovered ${data.steps.length} wizard step(s)!`, 'success');
    }

    renderCuicReports();

  } catch(e) {
    showToast('Discovery failed: ' + e.message, 'error');
  } finally {
    btn.innerHTML = origHtml;
    btn.disabled = false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BUILD / POPULATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncReportInputs() {
  document.querySelectorAll('.report-card').forEach((card, i) => {
    const inputs = card.querySelectorAll('.inline-row input');
    if (inputs[0]) cuicReports[i].label  = inputs[0].value;
    if (inputs[1]) cuicReports[i].folder = inputs[1].value;
    if (inputs[2]) cuicReports[i].name   = inputs[2].value;
  });
}

function buildSettings() {
  syncReportInputs();
  return {
    global: {
      headless:             document.getElementById('g-headless').checked,
      use_system_chrome:    document.getElementById('g-system-chrome').checked,
      screenshot_steps:     document.getElementById('g-screenshot-steps').checked,
      screenshot_errors:    document.getElementById('g-screenshot-errors').checked,
      log_level:            document.getElementById('g-log-level').value,
      output_dir:           document.getElementById('g-output-dir').value,
      log_dir:              document.getElementById('g-log-dir').value,
      data_retention_days:  parseInt(document.getElementById('g-retention').value) || 90,
      shared_drive_csv:     document.getElementById('g-shared-drive').value
    },
    workers: {
      cuic: {
        enabled:            document.getElementById('cuic-enabled').checked,
        url:                document.getElementById('cuic-url').value,
        reports:            cuicReports.map(r => {
          const f = Object.assign({}, r.filters || {});
          if (r._wizard_meta) f._meta = r._wizard_meta;
          return { label: r.label, folder: r.folder, name: r.name, enabled: r.enabled !== false, filters: f };
        }),
        timeout_nav_ms:     parseInt(document.getElementById('cuic-t-nav').value) || 30000,
        timeout_short_ms:   parseInt(document.getElementById('cuic-t-short').value) || 1500,
        timeout_medium_ms:  parseInt(document.getElementById('cuic-t-medium').value) || 2500,
        timeout_long_ms:    parseInt(document.getElementById('cuic-t-long').value) || 8000
      },
      smax: {
        enabled:              document.getElementById('smax-enabled').checked,
        base_url:             document.getElementById('smax-url').value,
        report_urls:          document.getElementById('smax-urls').value.split('\n').map(s=>s.trim()).filter(Boolean),
        page_load_timeout_ms: parseInt(document.getElementById('smax-t-load').value) || 120000,
        element_wait_timeout_ms: parseInt(document.getElementById('smax-t-elem').value) || 30000,
        tab_stagger_delay_ms: parseInt(document.getElementById('smax-t-stagger').value) || 2000,
        max_retries:          parseInt(document.getElementById('smax-retries').value) || 2
      }
    }
  };
}

function buildCredentials() {
  return {
    cuic: { username: document.getElementById('cuic-user').value, password: document.getElementById('cuic-pass').value },
    smax: { username: document.getElementById('smax-user').value, password: document.getElementById('smax-pass').value }
  };
}

function populateSettings(s) {
  const g = s.global || {};
  setBool('g-headless', g.headless, true);
  setBool('g-system-chrome', g.use_system_chrome, true);
  setBool('g-screenshot-steps', g.screenshot_steps, false);
  setBool('g-screenshot-errors', g.screenshot_errors, true);
  setVal('g-log-level', g.log_level || 'INFO');
  setVal('g-output-dir', g.output_dir || 'output');
  setVal('g-log-dir', g.log_dir || 'logs');
  setVal('g-retention', g.data_retention_days || 90);
  setVal('g-shared-drive', g.shared_drive_csv || '');

  const cuic = (s.workers || {}).cuic || {};
  setBool('cuic-enabled', cuic.enabled, true);
  setVal('cuic-url', cuic.url || 'https://148.151.32.77:8444/cuicui/Main.jsp');
  cuicReports = (cuic.reports || []).map(r => {
    const rep = { label: r.label||'', folder: r.folder||'', name: r.name||'', enabled: r.enabled !== false, filters: r.filters||{} };
    if (rep.filters._meta) rep._wizard_meta = rep.filters._meta;
    return rep;
  });
  if (!cuicReports.length) cuicReports.push({ label:'call_type_hist', folder:'Test', name:'Z Call Type Historical All Fields', enabled:true, filters:{} });
  renderCuicReports();
  setVal('cuic-t-nav', cuic.timeout_nav_ms || 30000);
  setVal('cuic-t-short', cuic.timeout_short_ms || 1500);
  setVal('cuic-t-medium', cuic.timeout_medium_ms || 2500);
  setVal('cuic-t-long', cuic.timeout_long_ms || 8000);

  const smax = (s.workers || {}).smax || {};
  setBool('smax-enabled', smax.enabled, false);
  setVal('smax-url', smax.base_url || 'https://smax.corp.pdo.om');
  setVal('smax-urls', (smax.report_urls || []).join('\n'));
  setVal('smax-t-load', smax.page_load_timeout_ms || 120000);
  setVal('smax-t-elem', smax.element_wait_timeout_ms || 30000);
  setVal('smax-t-stagger', smax.tab_stagger_delay_ms || 2000);
  setVal('smax-retries', smax.max_retries || 2);
}

function populateCredentials(c) {
  setVal('cuic-user', (c.cuic||{}).username||'');
  setVal('cuic-pass', (c.cuic||{}).password||'');
  setVal('smax-user', (c.smax||{}).username||'');
  setVal('smax-pass', (c.smax||{}).password||'');
}

function setBool(id, val, def) { document.getElementById(id).checked = val !== undefined ? val : def; }
function setVal(id, val) { const el = document.getElementById(id); if (el) el.value = val; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE / LOAD VIA API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveAll() {
  try {
    const [r1, r2] = await Promise.all([
      fetch('/api/settings',    { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(buildSettings()) }),
      fetch('/api/credentials', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(buildCredentials()) })
    ]);
    if (r1.ok && r2.ok) showToast('Settings saved!');
    else showToast('Save failed: ' + (await r1.text()) + (await r2.text()), 'error');
  } catch(e) {
    showToast('Server offline ‚Äî use Export tab to copy JSON manually', 'error');
  }
}

async function loadFromServer() {
  try {
    const [sRes, cRes, statusRes, logRes] = await Promise.all([
      fetch('/api/settings'), fetch('/api/credentials'),
      fetch('/api/scrape-status').catch(()=>null),
      fetch('/api/scrape-log?limit=50').catch(()=>null)
    ]);
    if (sRes.ok) populateSettings(await sRes.json());
    if (cRes.ok) populateCredentials(await cRes.json());
    if (statusRes?.ok) {
      const data = await statusRes.json();
      scrapeStatus = {};
      (data||[]).forEach(s => scrapeStatus[s.source+':'+s.report_label] = s);
      renderCuicReports();
      updateDashboard(data);
    }
    if (logRes?.ok) renderScrapeLog(await logRes.json());
    document.getElementById('server-status').classList.remove('offline');
    document.getElementById('server-status-text').textContent = 'Connected';
  } catch(e) {
    console.warn('Server not available', e);
    document.getElementById('server-status').classList.add('offline');
    document.getElementById('server-status-text').textContent = 'Offline';
    resetDefaults();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDashboard(statusData) {
  document.getElementById('stat-total-reports').textContent = cuicReports.length;
  if (!statusData?.length) {
    document.getElementById('stat-last-run').textContent = 'Never';
    document.getElementById('stat-success-rate').textContent = '-';
    document.getElementById('stat-total-rows').textContent = '0';
    return;
  }
  document.getElementById('stat-last-run').textContent = statusData[0].timestamp || '-';
  const ok = statusData.filter(s => s.status === 'success').length;
  document.getElementById('stat-success-rate').textContent = Math.round(ok/statusData.length*100) + '%';
  document.getElementById('stat-total-rows').textContent = statusData.reduce((s,r) => s + (r.row_count||0), 0).toLocaleString();
}

function renderScrapeLog(log) {
  const tb = document.getElementById('scrape-log-body');
  if (!log?.length) { tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted)">No scrape history yet.</td></tr>'; return; }
  tb.innerHTML = log.map(r => `<tr>
    <td>${esc(r.timestamp)}</td><td>${esc(r.source)}</td><td>${esc(r.report_label)}</td>
    <td><span class="status-pill ${r.status}">${r.status}</span></td>
    <td>${r.row_count||0}</td><td>${r.duration_s?r.duration_s.toFixed(1)+'s':'-'}</td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${attr(r.message)}">${esc(r.message||'')}</td>
  </tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT / IMPORT / DEFAULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateJSON() {
  document.getElementById('out-settings').value = JSON.stringify(buildSettings(), null, 2);
  document.getElementById('out-credentials').value = JSON.stringify(buildCredentials(), null, 2);
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector('[data-tab="export"]').classList.add('active');
  document.getElementById('tab-export').classList.add('active');
  showToast('JSON generated!');
}

function loadFromJSON() {
  try {
    const st = document.getElementById('in-settings').value.trim();
    const ct = document.getElementById('in-credentials').value.trim();
    if (st) populateSettings(JSON.parse(st));
    if (ct) populateCredentials(JSON.parse(ct));
    showToast('Form populated from JSON');
  } catch(e) { showToast('Invalid JSON: ' + e.message, 'error'); }
}

function resetDefaults() {
  populateSettings({
    global: { headless:true, use_system_chrome:true, screenshot_steps:false, screenshot_errors:true,
              log_level:'INFO', output_dir:'output', log_dir:'logs', data_retention_days:90, shared_drive_csv:'' },
    workers: {
      cuic: { enabled:true, url:'https://148.151.32.77:8444/cuicui/Main.jsp',
              reports:[{label:'call_type_hist',folder:'Test',name:'Z Call Type Historical All Fields',enabled:true,filters:{}},
                      {label:'agent_hist',folder:'Stock/CCE/CCE_AF_Historical',name:'Agent Historical All Fields',enabled:true,filters:{}}],
              timeout_nav_ms:30000, timeout_short_ms:1500, timeout_medium_ms:2500, timeout_long_ms:8000 },
      smax: { enabled:false, base_url:'https://smax.corp.pdo.om', report_urls:[],
              page_load_timeout_ms:120000, element_wait_timeout_ms:30000, tab_stagger_delay_ms:2000, max_retries:2 }
    }
  });
  populateCredentials({cuic:{username:'',password:''},smax:{username:'',password:''}});
  showToast('Reset to defaults', 'info');
}

function copyToClipboard(id) {
  const el = document.getElementById(id); el.select(); document.execCommand('copy');
  showToast('Copied!');
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadFromServer();
</script>
</body>
</html>
